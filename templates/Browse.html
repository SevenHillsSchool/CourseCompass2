<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Browse</title>
  <link rel="stylesheet" href="styling/Browse.css">
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      let selectedOption1 = '';
      let selectedOption2 = '';
      let selectedOption3 = '';
      let selectedOption4 = '';
      let data = { names: "", ids: "" };
      let searchParameters = { input: "" };
      let nextPage = { input: "" };
      let dropdowns = { divisions: [], subjects: [], courses: [], teachers: [] };

      // Fetch dropdown data from server on page load
      dataFromServer = {{ dropDownData | tojson | safe }};
      dropdowns = {
        Divisions: dataFromServer.Divisions.split("'").join("").split(", "),
        Subjects: dataFromServer.Subjects.split("'").join("").split(", "),
        Courses: dataFromServer.Courses.split("'").join("").split(", "),
        Teachers: dataFromServer.Teachers.split("'").join("").split(", ")
      };
      updateDropdownOptions();

      // Update dropdown options based on the fetched data
      function updateDropdownOptions() {
        const dropdown1 = document.getElementById('dropdown1');
        const dropdown2 = document.getElementById('dropdown2');
        const dropdown3 = document.getElementById('dropdown3');
        const dropdown4 = document.getElementById('dropdown4');

        dropdown1.innerHTML = `<option value="">Select School</option>` + dropdowns.Divisions.map(option => `<option value="${option}">${option}</option>`).join('');
        dropdown2.innerHTML = `<option value="">Select Department/Grade</option>` + dropdowns.Subjects.map(option => `<option value="${option}">${option}</option>`).join('');
        dropdown3.innerHTML = `<option value="">Select Course</option>` + dropdowns.Courses.map(option => `<option value="${option}">${option}</option>`).join('');
        dropdown4.innerHTML = `<option value="">Select Teacher</option>` + dropdowns.Teachers.map(option => `<option value="${option}">${option}</option>`).join('');
      }

      // Function to handle search parameters and perform search
      function sendSearchRequest() {
        if (!(selectedOption1 === '' && selectedOption2 === '' && selectedOption3 === '' && selectedOption4 === '')) {
          searchParameters.input = (selectedOption1 + "," + selectedOption2 + "," + selectedOption3 + "," + selectedOption4);
        } else {
          searchParameters.input = '';
        }

        if (searchParameters.input === "") {
          return;
        }

        fetch('/search', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: 'data=' + encodeURIComponent(JSON.stringify(searchParameters.input))
        })
        .then(res => res.json())
        .then(result => {
          data.names = result.Names || "No results.";
          data.ids = result.Ids || "";
          showResults();
        })
        .catch((error) => {
          console.error('Error:', error);
        });
      }

      // Show results by adding them to the HTML
      function showResults() {
        let resultsContainer = document.getElementById("results");
        let nameList = data.names.split(",");
        let idList = data.ids.split(",");
        let resultText = "<ul>";

        nameList.forEach((name, index) => {
          resultText += `<br>
            <li>
              <button class="link-button" onclick="handleNameClick(${idList[index]})">${name}</button>
            </li>`;
        });

        resultText += "</ul>";
        resultsContainer.innerHTML = resultText;
      }

      // Handle the name click event to open a new page
      function handleNameClick(idValue) {
        nextPage.input = idValue;
        fetch('/getCourseInfo', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: 'data=' + encodeURIComponent(JSON.stringify(nextPage.input))
        })
        .then(res => res.json())
        .then(data => {
          console.log(data);
          window.open("/course-info", "_self");
        })
        .catch(error => {
          console.error('Error:', error);
        });
      }

      // Event listeners for dropdowns
      document.getElementById('dropdown1').addEventListener('change', function(e) {
        selectedOption1 = e.target.value;
      });
      document.getElementById('dropdown2').addEventListener('change', function(e) {
        selectedOption2 = e.target.value;
      });
      document.getElementById('dropdown3').addEventListener('change', function(e) {
        selectedOption3 = e.target.value;
      });
      document.getElementById('dropdown4').addEventListener('change', function(e) {
        selectedOption4 = e.target.value;
      });

      // Search button event
      document.getElementById('searchBtn').addEventListener('click', sendSearchRequest);
    });
  </script>
</head>
<body>
  {% include "NavigationBar.html" %}
  <div style="padding: 100px; font-family: Arial, sans-serif;">
    <h1>Please Select School/Department/Course/Teacher</h1>

    <!-- Dropdowns for filtering -->
    <div>
      <select id="dropdown1">
        <option value="">Select School</option>
      </select>
    </div>
    <div>
      <select id="dropdown2">
        <option value="">Select Department/Grade</option>
      </select>
    </div>
    <div>
      <select id="dropdown3">
        <option value="">Select Course</option>
      </select>
    </div>
    <div>
      <select id="dropdown4">
        <option value="">Select Teacher</option>
      </select>
    </div>

    <div style="margin-top: 20px;">
      <h2>Selected Options:</h2>
      <p>Dropdown 1: <span id="selected1">None</span></p>
      <p>Dropdown 2: <span id="selected2">None</span></p>
      <p>Dropdown 3: <span id="selected3">None</span></p>
      <p>Dropdown 4: <span id="selected4">None</span></p>
    </div>

    <button id="searchBtn" class="sendBtn">Search</button>
    <div id="results" class="thing"></div>
  </div>
</body>
</html>
